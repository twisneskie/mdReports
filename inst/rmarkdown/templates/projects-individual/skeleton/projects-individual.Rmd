---
title: "`r project$projectTitle`"
subtitle: "Project Report"
date: "`r format(Sys.time(), '%d %B, %Y')`"
author: "Generated by: `r Sys.getenv('USERNAME')`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: spacelab 

---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)

```

## Project Abstract
`r dplyr::pull(project, abstract)`

## Data Management Personnel
```{r dm.personnel}
project %>%
  
  tidyr::unnest_wider("projectPersonnel") %>%
  
  dplyr::select(essential_personnel) %>%

  knitr::kable(col.names = c("Data Trustee",
                             "Data Steward",
                             "Data Custodian")) %>%
  
  kableExtra::kable_styling(full_width = FALSE, position = "left")
```

## All Resources

```{r all.resources}
project %>%
  
  tidyr::unnest("data") %>%
  
  dplyr::mutate(uri = ifelse(uri == "NULL",
                             NA,
                             uri)) %>%

  tidyr::unnest_longer("uri") %>%
  
  dplyr::mutate(location = stringr::str_extract(uri,
                                           "(?<=\\.)([:alpha:]+$)") %>%
                stringr::str_to_upper()) %>%
  
  dplyr::mutate(location = stringr::str_c('<a href="',
                                          uri,
                                          '">',
                                          location,
                                          '</a>'),
                .keep = "unused") %>%
  
  dplyr::group_by(dplyr::across(-c("location"))) %>%
  
  tidyr::nest() %>%
  
  dplyr::ungroup() %>%
  
  tidyr::unnest_wider("data") %>%
  
  tidyr::unnest_wider("location",
                      names_sep = ".") %>%
  
  tidyr::unite("location",
               tidyr::contains("."),
               sep = ", ",
               na.rm = TRUE) %>%

  
  dplyr::mutate(hasMetadata = dplyr::if_else(is.na(status), 
                                            "Intitiated", 
                                            "Completed"),
                dataOriginator = dplyr::if_else(dataOriginator == "",
                                                "None assigned",
                                                dataOriginator),
                location = dplyr::if_else(location == "",
                                     "File Not Archived",
                                     location)) %>%
  
  dplyr::select("title",
                "productType",
                "hasMetadata",
                "dataOriginator",
                "location") %>%
  
  DT::datatable(filter = "top",
                options = list(pageLength = 5,
                               lengthMenu = c(5, 
                                              10, 
                                              15, 
                                              20),
                               scrollX = TRUE,
                               columnDefs = list(list(width = '20%',
                                                      targets = list(1, 4)
                                                      )
                                                 )
                               ),
                autoHideNavigation = getOption("DT.autoHideNavigation",
                                               TRUE),
                width = "10in",
                colnames = c("Title",
                             "Type",
                             "Has Metadata",
                             "Data Originator",
                             "File"),
                escape = FALSE)

```

## Resources With Data Dictionaries
```{r data.dictionaries, results='asis'}

dictionaryTable <- project %>%
  
  tidyr::unnest("data")

dictionaryTable <- dplyr::filter(dictionaryTable,
                                 dictionaryTable$dataDictionary != "NULL") %>%
  dplyr::select(Title = "title")

if(nrow(dictionaryTable) > 0) {
  
  dictionaryTable %>%
    
    knitr::kable() %>%
    
    kableExtra::kable_styling(full_width = FALSE, position = "left")
  
} else {

  cat("No data dictionaries have been created for this project.")
}

```

